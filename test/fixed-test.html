<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤éªŒè¯æµ‹è¯• - bulk-print-js</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            background: #f5f5f5; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin: 3px 0; padding: 3px; border-radius: 3px; }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-warning { background: #fff3cd; color: #856404; }
        
        /* æµ‹è¯•ä¸åŒçš„é¡µé¢é€‰æ‹©å™¨ */
        .page-box { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 20px; 
            page-break-after: always;
            display: none;
        }
        .print-page { 
            border: 1px solid #999; 
            margin: 10px 0; 
            padding: 20px; 
            page-break-after: always;
            display: none;
            background: #f9f9f9;
        }
        
        @media print {
            body { margin: 0; }
            .test-section, button, .log { display: none; }
            .page-box, .print-page { display: block !important; border: none; }
        }
    </style>
</head>
<body>
    <h1>âœ… ä¿®å¤éªŒè¯æµ‹è¯• - bulk-print-js</h1>
    
    <div class="test-section">
        <h3>ğŸ”§ ä¿®å¤éªŒè¯æµ‹è¯•</h3>
        <button onclick="testCustomSelector()">è‡ªå®šä¹‰é€‰æ‹©å™¨æµ‹è¯•</button>
        <button onclick="testInputValidation()">è¾“å…¥éªŒè¯æµ‹è¯•</button>
        <button onclick="testConfigPersistence()">é…ç½®æŒä¹…æ€§æµ‹è¯•</button>
        <button onclick="testErrorHandling()">é”™è¯¯å¤„ç†æµ‹è¯•</button>
        <button onclick="clearLog()" class="success">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ æµ‹è¯•ç»“æœ</h3>
        <div id="testResults"></div>
    </div>

    <div class="log" id="log"></div>

    <!-- æµ‹è¯•ä¸åŒçš„é¡µé¢é€‰æ‹©å™¨ -->
    <div id="print-container">
        <div class="page-box">
            <h2>é¡µé¢ 1 (page-box)</h2>
            <p>è¿™æ˜¯ä½¿ç”¨ page-box ç±»çš„ç¬¬ä¸€é¡µ</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="page-box">
            <h2>é¡µé¢ 2 (page-box)</h2>
            <p>è¿™æ˜¯ä½¿ç”¨ page-box ç±»çš„ç¬¬äºŒé¡µ</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>é¡µé¢ 3 (print-page)</h2>
            <p>è¿™æ˜¯ä½¿ç”¨ print-page ç±»çš„ç¬¬ä¸‰é¡µ</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>é¡µé¢ 4 (print-page)</h2>
            <p>è¿™æ˜¯ä½¿ç”¨ print-page ç±»çš„ç¬¬å››é¡µ</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
    </div>

    <script src="../dist/bulk-print.umd.js"></script>
    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            
            testResults.push({ time: new Date().toISOString(), message, type });
        }

        function updateTestResults() {
            const resultsEl = document.getElementById('testResults');
            const passed = testResults.filter(r => r.type === 'success').length;
            const failed = testResults.filter(r => r.type === 'error').length;
            const warnings = testResults.filter(r => r.type === 'warning').length;
            
            resultsEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div style="background: #d4edda; padding: 10px; border-radius: 4px; text-align: center;">
                        <strong>âœ… é€šè¿‡</strong><br>${passed}
                    </div>
                    <div style="background: #f8d7da; padding: 10px; border-radius: 4px; text-align: center;">
                        <strong>âŒ å¤±è´¥</strong><br>${failed}
                    </div>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; text-align: center;">
                        <strong>âš ï¸ è­¦å‘Š</strong><br>${warnings}
                    </div>
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 4px; text-align: center;">
                        <strong>ğŸ“Š æ€»è®¡</strong><br>${testResults.length}
                    </div>
                </div>
            `;
        }

        function updateTimestamps() {
            document.querySelectorAll('.timestamp').forEach(el => {
                el.textContent = new Date().toLocaleString();
            });
        }

        // æµ‹è¯•è‡ªå®šä¹‰é€‰æ‹©å™¨
        async function testCustomSelector() {
            log('ğŸ§ª å¼€å§‹è‡ªå®šä¹‰é€‰æ‹©å™¨æµ‹è¯•', 'info');
            
            try {
                // æµ‹è¯• page-box é€‰æ‹©å™¨
                const printer1 = new BulkPrint({
                    pageSelector: '.page-box',
                    autoMode: true
                });
                
                await printer1.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 2
                });
                log('âœ… page-box é€‰æ‹©å™¨æµ‹è¯•æˆåŠŸ', 'success');
                
                // æµ‹è¯• print-page é€‰æ‹©å™¨
                const printer2 = new BulkPrint({
                    pageSelector: '.print-page',
                    autoMode: true
                });
                
                await printer2.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 2
                });
                log('âœ… print-page é€‰æ‹©å™¨æµ‹è¯•æˆåŠŸ', 'success');
                
                // æµ‹è¯•ä¸å­˜åœ¨çš„é€‰æ‹©å™¨
                const printer3 = new BulkPrint({
                    pageSelector: '.non-existent',
                    autoMode: true
                });
                
                try {
                    await printer3.print({
                        printElement: document.getElementById('print-container'),
                        totalPages: 1
                    });
                    log('âŒ ä¸å­˜åœ¨é€‰æ‹©å™¨æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
                } catch (error) {
                    log('âœ… ä¸å­˜åœ¨é€‰æ‹©å™¨æµ‹è¯•æˆåŠŸï¼ˆæ­£ç¡®æŠ¥é”™ï¼‰', 'success');
                }
                
            } catch (error) {
                log(`âŒ è‡ªå®šä¹‰é€‰æ‹©å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateTestResults();
        }

        // æµ‹è¯•è¾“å…¥éªŒè¯
        async function testInputValidation() {
            log('ğŸ§ª å¼€å§‹è¾“å…¥éªŒè¯æµ‹è¯•', 'info');
            
            try {
                // æµ‹è¯•ç©ºå‚æ•°
                try {
                    const printer1 = new BulkPrint();
                    await printer1.print();
                    log('âŒ ç©ºå‚æ•°æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
                } catch (error) {
                    log('âœ… ç©ºå‚æ•°éªŒè¯æˆåŠŸ', 'success');
                }
                
                // æµ‹è¯•æ— æ•ˆå…ƒç´ 
                try {
                    const printer2 = new BulkPrint();
                    await printer2.print({
                        printElement: null,
                        totalPages: 1
                    });
                    log('âŒ æ— æ•ˆå…ƒç´ æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
                } catch (error) {
                    log('âœ… æ— æ•ˆå…ƒç´ éªŒè¯æˆåŠŸ', 'success');
                }
                
                // æµ‹è¯•æ— æ•ˆé¡µæ•°
                try {
                    const printer3 = new BulkPrint();
                    await printer3.print({
                        printElement: document.getElementById('print-container'),
                        totalPages: -1
                    });
                    log('âŒ è´Ÿæ•°é¡µæ•°æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
                } catch (error) {
                    log('âœ… è´Ÿæ•°é¡µæ•°éªŒè¯æˆåŠŸ', 'success');
                }
                
                // æµ‹è¯•0é¡µæ•°
                try {
                    const printer4 = new BulkPrint();
                    await printer4.print({
                        printElement: document.getElementById('print-container'),
                        totalPages: 0
                    });
                    log('âŒ 0é¡µæ•°æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
                } catch (error) {
                    log('âœ… 0é¡µæ•°éªŒè¯æˆåŠŸ', 'success');
                }
                
            } catch (error) {
                log(`âŒ è¾“å…¥éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateTestResults();
        }

        // æµ‹è¯•é…ç½®æŒä¹…æ€§
        async function testConfigPersistence() {
            log('ğŸ§ª å¼€å§‹é…ç½®æŒä¹…æ€§æµ‹è¯•', 'info');
            
            try {
                // åˆ›å»ºå®ä¾‹å¹¶è®¾ç½®åˆå§‹é…ç½®
                const printer = new BulkPrint({
                    batchSize: 50,
                    autoMode: false,
                    confirmEachBatch: true
                });
                
                // æ¨¡æ‹Ÿç”¨æˆ·é€‰æ‹©è‡ªåŠ¨æ¨¡å¼ï¼ˆä¸åº”è¯¥ä¿®æ”¹åŸå§‹é…ç½®ï¼‰
                const originalConfirm = window.confirm;
                let confirmCallCount = 0;
                window.confirm = () => {
                    confirmCallCount++;
                    return true; // æ€»æ˜¯é€‰æ‹©è‡ªåŠ¨æ¨¡å¼
                };
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 2,
                    batchThreshold: 1, // å¼ºåˆ¶åˆ†æ‰¹
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šä¿®å¤éªŒè¯è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                window.confirm = originalConfirm; // æ¢å¤åŸå§‹confirm
                
                // éªŒè¯é…ç½®æ˜¯å¦ä¿æŒä¸å˜
                const stats = printer.getStats();
                if (confirmCallCount > 0) {
                    log('âœ… é…ç½®æŒä¹…æ€§æµ‹è¯•æˆåŠŸï¼ˆç”¨æˆ·ç¡®è®¤è¢«æ­£ç¡®è°ƒç”¨ï¼‰', 'success');
                } else {
                    log('âš ï¸ é…ç½®æŒä¹…æ€§æµ‹è¯•è­¦å‘Šï¼ˆç”¨æˆ·ç¡®è®¤æœªè¢«è°ƒç”¨ï¼‰', 'warning');
                }
                
            } catch (error) {
                log(`âŒ é…ç½®æŒä¹…æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateTestResults();
        }

        // æµ‹è¯•é”™è¯¯å¤„ç†
        async function testErrorHandling() {
            log('ğŸ§ª å¼€å§‹é”™è¯¯å¤„ç†æµ‹è¯•', 'info');
            
            try {
                const printer = new BulkPrint({
                    autoMode: true
                });
                
                // æ³¨å†Œä¼šå‡ºé”™çš„äº‹ä»¶å¤„ç†å™¨
                let errorHandled = false;
                printer.on('error', (error) => {
                    if (error.message.includes('æµ‹è¯•äº‹ä»¶å¤„ç†å™¨é”™è¯¯')) {
                        errorHandled = true;
                    }
                });
                
                printer.on('progress', () => {
                    throw new Error('æµ‹è¯•äº‹ä»¶å¤„ç†å™¨é”™è¯¯');
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 1,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šé”™è¯¯å¤„ç†è‡ªå®šä¹‰å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                if (errorHandled) {
                    log('âœ… é”™è¯¯å¤„ç†æµ‹è¯•æˆåŠŸï¼ˆäº‹ä»¶é”™è¯¯è¢«æ­£ç¡®æ•è·ï¼‰', 'success');
                } else {
                    log('âš ï¸ é”™è¯¯å¤„ç†æµ‹è¯•è­¦å‘Šï¼ˆäº‹ä»¶é”™è¯¯æœªè¢«æ­£ç¡®å¤„ç†ï¼‰', 'warning');
                }
                
            } catch (error) {
                log(`âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            updateTestResults();
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = [];
            updateTestResults();
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©ºï¼Œå¼€å§‹æ–°çš„æµ‹è¯•', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateTimestamps();
            log('ğŸš€ ä¿®å¤éªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“‹ ä¿®å¤å†…å®¹ï¼š', 'info');
            log('  1. âœ… æ·»åŠ å¯é…ç½®çš„é¡µé¢é€‰æ‹©å™¨', 'success');
            log('  2. âœ… å¢å¼ºè¾“å…¥å‚æ•°éªŒè¯', 'success');
            log('  3. âœ… ä¿®å¤é…ç½®æŒä¹…æ€§é—®é¢˜', 'success');
            log('  4. âœ… æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶', 'success');
            log('  5. âœ… ä¼˜åŒ–DOMæ“ä½œæ€§èƒ½', 'success');
            updateTestResults();
        });
    </script>
</body>
</html>