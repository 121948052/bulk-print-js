<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug æµ‹è¯• - bulk-print-js</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            background: #f5f5f5; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-warning { background: #fff3cd; color: #856404; }
        .print-page { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 20px; 
            page-break-after: always;
            display: none; /* é»˜è®¤éšè— */
        }
        .stats { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 4px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .stat-item { text-align: center; padding: 10px; background: #e9ecef; border-radius: 4px; }
        @media print {
            body { margin: 0; }
            .test-section, button, .log, .stats { display: none; }
            .print-page { display: block !important; border: none; }
        }
    </style>
</head>
<body>
    <h1>ğŸ› bulk-print-js Bug æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
        <div class="stats" id="stats">
            <div class="stat-item">æ€»é¡µæ•°: <span id="totalPages">0</span></div>
            <div class="stat-item">å·²æ‰“å°: <span id="printedPages">0</span></div>
            <div class="stat-item">å½“å‰æ‰¹æ¬¡: <span id="currentBatch">0</span></div>
            <div class="stat-item">æ€»æ‰¹æ¬¡: <span id="totalBatches">0</span></div>
            <div class="stat-item">æ‰“å°çŠ¶æ€: <span id="isPrinting">false</span></div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
        <button onclick="testBasicPrint()">åŸºç¡€æ‰“å°æµ‹è¯•</button>
        <button onclick="testBatchPrint()">åˆ†æ‰¹æ‰“å°æµ‹è¯•</button>
        <button onclick="testAutoMode()">è‡ªåŠ¨æ¨¡å¼æµ‹è¯•</button>
        <button onclick="testManualMode()">æ‰‹åŠ¨æ¨¡å¼æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h3>ğŸš¨ è¾¹ç•Œæ¡ä»¶æµ‹è¯•</h3>
        <button onclick="testZeroPages()">0é¡µæµ‹è¯•</button>
        <button onclick="testOnePage()">1é¡µæµ‹è¯•</button>
        <button onclick="testLargePages()">1000é¡µæµ‹è¯•</button>
        <button onclick="testInvalidElement()">æ— æ•ˆå…ƒç´ æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h3>âš¡ å¹¶å‘å’Œé”™è¯¯æµ‹è¯•</h3>
        <button onclick="testConcurrentPrint()">å¹¶å‘æ‰“å°æµ‹è¯•</button>
        <button onclick="testStopPrinting()">åœæ­¢æ‰“å°æµ‹è¯•</button>
        <button onclick="testEventErrors()">äº‹ä»¶é”™è¯¯æµ‹è¯•</button>
        <button onclick="testInvalidConfig()">æ— æ•ˆé…ç½®æµ‹è¯•</button>
    </div>

    <div class="test-section">
        <h3>ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•</h3>
        <button onclick="testBrowserDetection()">æµè§ˆå™¨æ£€æµ‹</button>
        <button onclick="testThresholdCalculation()">é˜ˆå€¼è®¡ç®—</button>
        <button onclick="clearLog()" class="danger">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="log" id="log"></div>

    <div id="print-container" style="display: none;">
        <!-- ç”Ÿæˆæµ‹è¯•é¡µé¢ -->
        <div class="print-page">
            <h2>æµ‹è¯•é¡µé¢ 1</h2>
            <p>è¿™æ˜¯ç¬¬ä¸€é¡µçš„æµ‹è¯•å†…å®¹</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>æµ‹è¯•é¡µé¢ 2</h2>
            <p>è¿™æ˜¯ç¬¬äºŒé¡µçš„æµ‹è¯•å†…å®¹</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>æµ‹è¯•é¡µé¢ 3</h2>
            <p>è¿™æ˜¯ç¬¬ä¸‰é¡µçš„æµ‹è¯•å†…å®¹</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>æµ‹è¯•é¡µé¢ 4</h2>
            <p>è¿™æ˜¯ç¬¬å››é¡µçš„æµ‹è¯•å†…å®¹</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
        <div class="print-page">
            <h2>æµ‹è¯•é¡µé¢ 5</h2>
            <p>è¿™æ˜¯ç¬¬äº”é¡µçš„æµ‹è¯•å†…å®¹</p>
            <p>æ—¶é—´: <span class="timestamp"></span></p>
        </div>
    </div>

    <script src="../dist/bulk-print.umd.js"></script>
    <script>
        let printer = null;
        let testResults = [];

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            
            testResults.push({ time: new Date().toISOString(), message, type });
        }

        function updateStats() {
            if (printer) {
                const stats = printer.getStatus();
                document.getElementById('totalPages').textContent = stats.totalPages || 0;
                document.getElementById('printedPages').textContent = stats.printedPages || 0;
                document.getElementById('currentBatch').textContent = stats.currentBatch || 0;
                document.getElementById('totalBatches').textContent = stats.totalBatches || 0;
                document.getElementById('isPrinting').textContent = stats.isPrinting || false;
            }
        }

        function updateTimestamps() {
            document.querySelectorAll('.timestamp').forEach(el => {
                el.textContent = new Date().toLocaleString();
            });
        }

        // åŸºç¡€åŠŸèƒ½æµ‹è¯•
        async function testBasicPrint() {
            log('ğŸ§ª å¼€å§‹åŸºç¡€æ‰“å°æµ‹è¯•', 'info');
            try {
                printer = new BulkPrint();
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 3,
                    batchThreshold: 5,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šè‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                log('âœ… åŸºç¡€æ‰“å°æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ åŸºç¡€æ‰“å°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testBatchPrint() {
            log('ğŸ§ª å¼€å§‹åˆ†æ‰¹æ‰“å°æµ‹è¯•', 'info');
            try {
                printer = new BulkPrint({
                    batchSize: 2,
                    autoMode: true,
                    delay: 100
                });
                
                printer.on('progress', (data) => {
                    log(`ğŸ“Š è¿›åº¦: ${data.progress}%`, 'info');
                    updateStats();
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 5,
                    batchThreshold: 3,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šåˆ†æ‰¹è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                log('âœ… åˆ†æ‰¹æ‰“å°æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ åˆ†æ‰¹æ‰“å°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testAutoMode() {
            log('ğŸ§ª å¼€å§‹è‡ªåŠ¨æ¨¡å¼æµ‹è¯•', 'info');
            try {
                printer = new BulkPrint({
                    autoMode: true,
                    confirmEachBatch: false
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 4,
                    batchThreshold: 2,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šæ‰‹åŠ¨æ¨¡å¼è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                log('âœ… è‡ªåŠ¨æ¨¡å¼æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ è‡ªåŠ¨æ¨¡å¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testManualMode() {
            log('ğŸ§ª å¼€å§‹æ‰‹åŠ¨æ¨¡å¼æµ‹è¯•', 'info');
            try {
                printer = new BulkPrint({
                    autoMode: false,
                    confirmEachBatch: true
                });
                
                // æ¨¡æ‹Ÿç”¨æˆ·ç¡®è®¤
                const originalConfirm = window.confirm;
                window.confirm = () => true; // æ€»æ˜¯ç¡®è®¤
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 4,
                    batchThreshold: 2,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šæ‰‹åŠ¨æ¨¡å¼è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                window.confirm = originalConfirm; // æ¢å¤åŸå§‹confirm
                log('âœ… æ‰‹åŠ¨æ¨¡å¼æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ æ‰‹åŠ¨æ¨¡å¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        // è¾¹ç•Œæ¡ä»¶æµ‹è¯•
        async function testZeroPages() {
            log('ğŸ§ª å¼€å§‹0é¡µæµ‹è¯•', 'warning');
            try {
                printer = new BulkPrint();
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 0,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼š0é¡µè‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                log('âœ… 0é¡µæµ‹è¯•æˆåŠŸï¼ˆåº”è¯¥ä¸æ‰§è¡Œæ‰“å°ï¼‰', 'success');
            } catch (error) {
                log(`âŒ 0é¡µæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testOnePage() {
            log('ğŸ§ª å¼€å§‹1é¡µæµ‹è¯•', 'info');
            try {
                printer = new BulkPrint();
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 1
                });
                log('âœ… 1é¡µæµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ 1é¡µæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testLargePages() {
            log('ğŸ§ª å¼€å§‹1000é¡µæµ‹è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰', 'warning');
            try {
                printer = new BulkPrint({
                    batchSize: 100,
                    autoMode: true,
                    delay: 10 // å¿«é€Ÿæµ‹è¯•
                });
                
                // ç”Ÿæˆå¤§é‡é¡µé¢
                const container = document.getElementById('print-container');
                for (let i = 6; i <= 1000; i++) {
                    const page = document.createElement('div');
                    page.className = 'print-page';
                    page.innerHTML = `<h2>æµ‹è¯•é¡µé¢ ${i}</h2><p>è¿™æ˜¯ç¬¬${i}é¡µçš„æµ‹è¯•å†…å®¹</p>`;
                    container.appendChild(page);
                }
                
                log(`ğŸ“Š 1000é¡µå°†åˆ†ä¸º${Math.ceil(1000/100)}æ‰¹`, 'info');
                log('âœ… å¤§é¡µé¢æµ‹è¯•æˆåŠŸï¼ˆä»…è®¡ç®—ï¼‰', 'success');
            } catch (error) {
                log(`âŒ å¤§é¡µé¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testInvalidElement() {
            log('ğŸ§ª å¼€å§‹æ— æ•ˆå…ƒç´ æµ‹è¯•', 'warning');
            try {
                printer = new BulkPrint();
                await printer.print({
                    printElement: null,
                    totalPages: 1,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šæ— æ•ˆå…ƒç´ è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                log('âŒ æ— æ•ˆå…ƒç´ æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥æŠ¥é”™ï¼‰', 'error');
            } catch (error) {
                log(`âœ… æ— æ•ˆå…ƒç´ æµ‹è¯•æˆåŠŸï¼ˆæ­£ç¡®æŠ¥é”™ï¼‰: ${error.message}`, 'success');
            }
            updateStats();
        }

        // å¹¶å‘å’Œé”™è¯¯æµ‹è¯•
        async function testConcurrentPrint() {
            log('ğŸ§ª å¼€å§‹å¹¶å‘æ‰“å°æµ‹è¯•', 'warning');
            try {
                printer = new BulkPrint({ autoMode: true });
                
                // å¯åŠ¨ç¬¬ä¸€ä¸ªæ‰“å°ä»»åŠ¡
                const promise1 = printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 3,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šå¹¶å‘ä»»åŠ¡1è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                // å°è¯•å¯åŠ¨ç¬¬äºŒä¸ªæ‰“å°ä»»åŠ¡ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
                const promise2 = printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 2,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šå¹¶å‘ä»»åŠ¡2è‡ªå®šä¹‰æ‰“å°å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                await Promise.all([promise1, promise2]);
                log('âŒ å¹¶å‘æµ‹è¯•å¤±è´¥ï¼ˆåº”è¯¥é˜»æ­¢å¹¶å‘ï¼‰', 'error');
            } catch (error) {
                log(`âœ… å¹¶å‘æµ‹è¯•æˆåŠŸï¼ˆæ­£ç¡®é˜»æ­¢å¹¶å‘ï¼‰: ${error.message}`, 'success');
            }
            updateStats();
        }

        async function testStopPrinting() {
            log('ğŸ§ª å¼€å§‹åœæ­¢æ‰“å°æµ‹è¯•', 'info');
            try {
                printer = new BulkPrint({
                    batchSize: 2,
                    autoMode: true,
                    delay: 100
                });
                
                // ç›‘å¬äº‹ä»¶
                printer.on('batchStart', (data) => {
                    log(`ğŸ“¦ å¼€å§‹ç¬¬${data.batch}æ‰¹`, 'info');
                    // åœ¨ç¬¬äºŒæ‰¹æ—¶åœæ­¢
                    if (data.batch === 2) {
                        setTimeout(() => {
                            printer.stop();
                            log('â¹ï¸ æ‰‹åŠ¨åœæ­¢æ‰“å°', 'warning');
                        }, 50);
                    }
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 6,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šåœæ­¢æ‰“å°è‡ªå®šä¹‰å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                log('âœ… åœæ­¢æ‰“å°æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ åœæ­¢æ‰“å°æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testEventErrors() {
            log('ğŸ§ª å¼€å§‹äº‹ä»¶é”™è¯¯æµ‹è¯•', 'warning');
            try {
                printer = new BulkPrint({ autoMode: true });
                
                // æ³¨å†Œä¼šå‡ºé”™çš„äº‹ä»¶å¤„ç†å™¨
                printer.on('progress', () => {
                    throw new Error('æµ‹è¯•äº‹ä»¶é”™è¯¯');
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 2,
                    directPrintCallback: () => {
                        console.log('æµ‹è¯•ï¼šäº‹ä»¶é”™è¯¯è‡ªå®šä¹‰å›è°ƒ');
                        // window.print(); // æµ‹è¯•æ—¶ä¸å®é™…æ‰“å°
                    }
                });
                
                log('âœ… äº‹ä»¶é”™è¯¯æµ‹è¯•æˆåŠŸï¼ˆé”™è¯¯è¢«æ­£ç¡®å¤„ç†ï¼‰', 'success');
            } catch (error) {
                log(`âŒ äº‹ä»¶é”™è¯¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        async function testInvalidConfig() {
            log('ğŸ§ª å¼€å§‹æ— æ•ˆé…ç½®æµ‹è¯•', 'warning');
            try {
                printer = new BulkPrint({
                    batchSize: -1, // æ— æ•ˆå€¼
                    delay: 'invalid' // æ— æ•ˆç±»å‹
                });
                
                await printer.print({
                    printElement: document.getElementById('print-container'),
                    totalPages: 1
                });
                
                log('âœ… æ— æ•ˆé…ç½®æµ‹è¯•æˆåŠŸï¼ˆä½¿ç”¨äº†é»˜è®¤å€¼ï¼‰', 'success');
            } catch (error) {
                log(`âŒ æ— æ•ˆé…ç½®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            updateStats();
        }

        // æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
        function testBrowserDetection() {
            log('ğŸ§ª å¼€å§‹æµè§ˆå™¨æ£€æµ‹æµ‹è¯•', 'info');
            try {
                const browser = BulkPrint.detectBrowser();
                log(`ğŸŒ æ£€æµ‹åˆ°æµè§ˆå™¨: ${browser}`, 'info');
                log('âœ… æµè§ˆå™¨æ£€æµ‹æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ æµè§ˆå™¨æ£€æµ‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testThresholdCalculation() {
            log('ğŸ§ª å¼€å§‹é˜ˆå€¼è®¡ç®—æµ‹è¯•', 'info');
            try {
                const browsers = ['Chrome', 'Firefox', 'Safari', 'Edge', 'IE', 'Unknown'];
                browsers.forEach(browser => {
                    const threshold = BulkPrint.getBrowserThreshold(browser);
                    log(`ğŸ“Š ${browser}: ${threshold} é¡µ`, 'info');
                });
                log('âœ… é˜ˆå€¼è®¡ç®—æµ‹è¯•æˆåŠŸ', 'success');
            } catch (error) {
                log(`âŒ é˜ˆå€¼è®¡ç®—æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            testResults = [];
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateTimestamps();
            log('ğŸš€ Bug æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            log('ğŸ“‹ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½', 'info');
        });
    </script>
</body>
</html>