<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§ä½¿ç”¨ç¤ºä¾‹ - bulk-print-js</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f7fa;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px;
        }
        .controls { 
            background: white; 
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-group { 
            margin: 15px 0; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            flex-wrap: wrap;
        }
        label { 
            min-width: 140px; 
            font-weight: 500;
            color: #333;
        }
        input, select { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="checkbox"] { 
            transform: scale(1.2); 
            min-width: auto;
        }
        button { 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin: 5px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover { background: #0056b3; }
        button.stop { background: #dc3545; }
        button.stop:hover { background: #c82333; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        .progress-container { 
            background: white; 
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .progress { 
            background: #e9ecef; 
            border-radius: 4px; 
            overflow: hidden; 
            height: 24px;
            margin: 15px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #007bff, #0056b3); 
            transition: width 0.3s ease; 
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }
        .stats { 
            background: white; 
            padding: 25px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .print-page { 
            border: 1px solid #ccc; 
            margin: 10px 0; 
            padding: 20px; 
            page-break-after: always;
            background: white;
        }
        .log-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-info { background: #e3f2fd; color: #1976d2; }
        .log-success { background: #e8f5e8; color: #2e7d32; }
        .log-warning { background: #fff3e0; color: #f57c00; }
        .log-error { background: #ffebee; color: #c62828; }
        
        @media print {
            body { margin: 0; background: white; }
            .header, .controls, .progress-container, .stats, .log-container, button { display: none; }
            .print-page { border: none; box-shadow: none; }
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ bulk-print-js é«˜çº§ä½¿ç”¨ç¤ºä¾‹</h1>
            <p>å®Œæ•´çš„é…ç½®é€‰é¡¹ã€äº‹ä»¶ç›‘å¬å’Œå®æ—¶ç›‘æ§æ¼”ç¤º</p>
        </div>
        
        <div class="controls">
            <div class="section-title">ğŸ“‹ æ‰“å°é…ç½®</div>
            <div class="control-group">
                <label>æ€»é¡µæ•°:</label>
                <input type="number" id="totalPages" value="100" min="1" max="1000">
                <label>æ‰¹æ¬¡å¤§å°:</label>
                <input type="number" id="batchSize" value="20" min="1" max="100">
            </div>
            <div class="control-group">
                <label>åˆ†æ‰¹é˜ˆå€¼:</label>
                <input type="number" id="threshold" value="50" min="10" max="200">
                <label>é¡µé¢é€‰æ‹©å™¨:</label>
                <input type="text" id="pageSelector" value=".print-page" placeholder=".print-page">
            </div>
            <div class="control-group">
                <label>æ˜¾ç¤ºè°ƒè¯•æ—¥å¿—:</label>
                <input type="checkbox" id="debugMode" checked>
                <label>æ™ºèƒ½æ‰¹æ¬¡å¤§å°:</label>
                <input type="checkbox" id="smartBatchSize" checked>
            </div>
            <div class="control-group">
                <button onclick="startPrint()">ğŸ¯ å¼€å§‹æ‰“å°</button>
                <button onclick="stopPrint()" class="stop">â¹ï¸ å–æ¶ˆæ‰“å°</button>
                <button onclick="resetStats()" class="secondary">ğŸ”„ é‡ç½®</button>
                <button onclick="exportLogs()" class="secondary">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="progress-container">
            <div class="section-title">ğŸ“Š æ‰“å°è¿›åº¦</div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div id="progressText">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div class="stats">
            <div class="section-title">ğŸ“ˆ å®æ—¶ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">å·²æ‰“å°é¡µæ•°</div>
                    <div class="stat-value" id="printedPages">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å½“å‰æ‰¹æ¬¡</div>
                    <div class="stat-value" id="currentBatch">0 / 0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ‰“å°é€Ÿåº¦</div>
                    <div class="stat-value" id="printSpeed">0 é¡µ/åˆ†</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å‰©ä½™æ—¶é—´</div>
                    <div class="stat-value" id="remainingTime">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">é¡µé¢é€‰æ‹©å™¨</div>
                    <div class="stat-value" id="currentSelector">.print-page</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å½“å‰é˜ˆå€¼</div>
                    <div class="stat-value" id="currentThreshold">50</div>
                </div>
            </div>
        </div>

        <div class="log-container">
            <div class="section-title">ğŸ“ æ“ä½œæ—¥å¿—</div>
            <div id="logOutput"></div>
        </div>

        <div id="print-container" style="display: none;">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ‰“å°å†…å®¹ -->
        </div>
    </div>

    <script src="../dist/bulk-print.umd.js"></script>
    <script>
        let printer = null;
        let isPrinting = false;
        let isPaused = false;
        let printStartTime = null;
        let logs = [];

        // åˆå§‹åŒ–
        function init() {
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            addLog('bulk-print-js å·²å‡†å¤‡å°±ç»ª', 'info');
            
            generatePrintContent();
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);
            
            if (document.getElementById('debugMode').checked) {
                const logOutput = document.getElementById('logOutput');
                const logElement = document.createElement('div');
                logElement.className = `log-entry log-${type}`;
                logElement.textContent = `[${timestamp}] ${message}`;
                logOutput.appendChild(logElement);
                logOutput.scrollTop = logOutput.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (logOutput.children.length > 100) {
                    logOutput.removeChild(logOutput.firstChild);
                }
            }
        }

        // ç”Ÿæˆæ‰“å°å†…å®¹
        function generatePrintContent() {
            const container = document.getElementById('print-container');
            const totalPages = parseInt(document.getElementById('totalPages').value);
            
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const page = document.createElement('div');
                page.className = 'print-page';
                page.innerHTML = `
                    <h2>ğŸ“„ æ‰“å°æ–‡æ¡£ - ç¬¬ ${i} é¡µ</h2>
                    <div style="margin: 20px 0;">
                        <p><strong>æ–‡æ¡£ç¼–å·:</strong> DOC-2024-${String(i).padStart(3, '0')}</p>
                        <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}</p>
                        <p><strong>é¡µé¢ä¿¡æ¯:</strong> ç¬¬ ${i} é¡µï¼Œå…± ${totalPages} é¡µ</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 4px;">
                        <h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                        <p>è¿™æ˜¯ç¬¬ ${i} é¡µçš„ç¤ºä¾‹å†…å®¹ï¼ŒåŒ…å«æµ‹è¯•æ•°æ®å’Œå›¾è¡¨å ä½ç¬¦ã€‚</p>
                        <div style="height: 120px; background: linear-gradient(45deg, #e9ecef 25%, transparent 25%, transparent 75%, #e9ecef 75%, #e9ecef), linear-gradient(45deg, #e9ecef 25%, transparent 25%, transparent 75%, #e9ecef 75%, #e9ecef); background-size: 20px 20px; background-position: 0 0, 10px 10px; display: flex; align-items: center; justify-content: center; color: #666; margin: 20px 0;">
                            ğŸ“ˆ å›¾è¡¨åŒºåŸŸ (ç¤ºä¾‹ ${i})
                        </div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                        <p>Â© 2024 bulk-print-js ç¤ºä¾‹æ–‡æ¡£ | é¡µç : ${i}</p>
                    </div>
                `;
                container.appendChild(page);
            }
            
            addLog(`ç”Ÿæˆäº† ${totalPages} é¡µæ‰“å°å†…å®¹`, 'success');
        }

        // å¼€å§‹æ‰“å°
        async function startPrint() {
            if (isPrinting) {
                addLog('æ­£åœ¨æ‰“å°ä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ', 'warning');
                return;
            }

            isPrinting = true;
            printStartTime = Date.now();
            generatePrintContent(); // é‡æ–°ç”Ÿæˆå†…å®¹

            const smartBatchSize = document.getElementById('smartBatchSize').checked;
            const config = {
                pageSelector: document.getElementById('pageSelector').value,
                threshold: parseInt(document.getElementById('threshold').value),
                batchSize: smartBatchSize ? undefined : parseInt(document.getElementById('batchSize').value)
            };

            const printOptions = {
                element: document.getElementById('print-container'),
                totalPages: parseInt(document.getElementById('totalPages').value)
            };

            addLog(`å¼€å§‹æ‰“å°ä»»åŠ¡: ${JSON.stringify(config)}`, 'info');
            updateProgress('åˆå§‹åŒ–æ‰“å°ä»»åŠ¡...', 'info');

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('currentSelector').textContent = config.pageSelector;
            document.getElementById('currentThreshold').textContent = config.threshold;

            try {
                printer = new BulkPrint(config);

                // äº‹ä»¶ç›‘å¬
                printer
                    .on('start', (data) => {
                        addLog(`ğŸš€ å¼€å§‹æ‰“å°: ${data.totalPages}é¡µï¼Œåˆ†${data.totalBatches}æ‰¹ï¼Œæ¯æ‰¹${data.batchSize}é¡µ`, 'info');
                        updateStats();
                    })
                    .on('batchStart', (data) => {
                        addLog(`ğŸ“¦ å¼€å§‹ç¬¬ ${data.batch} æ‰¹æ‰“å° (${data.pagesInBatch} é¡µ)`, 'info');
                        updateStats();
                        const progress = Math.round((data.batch / data.totalBatches) * 100);
                        updateProgressBar(progress);
                    })
                    .on('batchComplete', (data) => {
                        addLog(`âœ… ç¬¬ ${data.batch} æ‰¹å®Œæˆ`, 'success');
                        updateStats();
                        const progress = Math.round((data.batch / data.totalBatches) * 100);
                        updateProgressBar(progress);
                    })
                    .on('cancel', (data) => {
                        addLog(`â¹ï¸ æ‰“å°è¢«å–æ¶ˆ: ${data.message}`, 'warning');
                        isPrinting = false;
                        updateStats();
                    });

                const result = await printer.print(printOptions);
                
                if (result.success) {
                    const duration = Date.now() - printStartTime;
                    addLog(`ğŸ‰ æ‰“å°å®Œæˆ! å…±æ‰“å° ${result.pages} é¡µï¼Œæ€»è€—æ—¶ ${duration}ms`, 'success');
                    updateProgressBar(100);
                }
            } catch (error) {
                addLog(`âŒ æ‰“å°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                isPrinting = false;
                updateStats();
            }
        }

        // åœæ­¢æ‰“å°
        function stopPrint() {
            if (printer && isPrinting) {
                const wasCancelled = printer.cancel();
                if (wasCancelled) {
                    addLog('æ‰“å°å·²å–æ¶ˆ', 'warning');
                } else {
                    addLog('æ— æ³•å–æ¶ˆæ‰“å°', 'warning');
                }
                isPrinting = false;
                updateStats();
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar(progress) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(message, type = 'info') {
            const progressText = document.getElementById('progressText');
            progressText.textContent = message;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (printer) {
                const stats = printer.getStatus();
                document.getElementById('printedPages').textContent = (stats.currentBatch * (printer.options.batchSize || 1)) || 0;
                document.getElementById('currentBatch').textContent = `${stats.currentBatch || 0} / ${stats.totalBatches || 0}`;
                
                // è®¡ç®—æ‰“å°é€Ÿåº¦
                if (printStartTime && stats.currentBatch > 0) {
                    const elapsedMinutes = (Date.now() - printStartTime) / 60000;
                    const printedPages = stats.currentBatch * (printer.options.batchSize || 1);
                    const speed = Math.round(printedPages / elapsedMinutes);
                    document.getElementById('printSpeed').textContent = speed + ' é¡µ/åˆ†';
                    
                    // ä¼°ç®—å‰©ä½™æ—¶é—´
                    const remainingPages = (stats.totalPages || 0) - printedPages;
                    if (speed > 0) {
                        const remainingMinutes = Math.round(remainingPages / speed);
                        document.getElementById('remainingTime').textContent = remainingMinutes + ' åˆ†é’Ÿ';
                    }
                }
            }
        }

        // é‡ç½®ç»Ÿè®¡
        function resetStats() {
            updateProgress('å‡†å¤‡å°±ç»ª', 'info');
            document.getElementById('printedPages').textContent = '0';
            document.getElementById('currentBatch').textContent = '0 / 0';
            document.getElementById('printSpeed').textContent = '0 é¡µ/åˆ†';
            document.getElementById('remainingTime').textContent = '--';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('logOutput').innerHTML = '';
            logs = [];
            isPrinting = false;
            printStartTime = null;
            addLog('ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®', 'info');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bulk-print-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>